{% extends "base.html" %}

{% block title %}Peer Review Results - Peer Review App{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h2 style="text-align: center;">Peer Review Results</h2>
    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 10px; margin: 10px 0; text-align: center;">
        <strong>Subject:</strong> {{ subject.name }} | <strong>Group:</strong> {{ group.name }}
    </div>

    <!-- Group Summary -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
        <p>
            <strong>Total Students:</strong> {{ group_students|length }} |
            <strong>Reviews Completed:</strong> {{ completed_count }}/{{ group_students|length }} |
            <strong>Status:</strong>
            {% if all_completed %}
                <span style="color: #28a745;">Complete ✓</span>
            {% else %}
                <span style="color: #dc3545;">In Progress ⏳</span>
            {% endif %}
        </p>
    </div>

    <!-- Results Table -->
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
        <thead style="background: #f8f9fa;">
            <tr>
                <th style="border: 1px solid #ddd; padding: 10px;">Student</th>
                <th style="border: 1px solid #ddd; padding: 10px;">Avg Peer Score</th>
                <th style="border: 1px solid #ddd; padding: 10px;">Final Mark</th>
                <th style="border: 1px solid #ddd; padding: 10px;">Comments</th>
            </tr>
        </thead>
        <tbody>
            {% for student in group_students %}
            {% set student_results = results[student.id] %}
            <tr>
                <td style="border: 1px solid #ddd; padding: 10px;"><strong>{{ student.first_name }} {{ student.last_name }}</strong></td>
                <td style="border: 1px solid #ddd; padding: 10px;">
                    {% if all_completed and student_results.avg_score %}
                        {{ student_results.avg_score|round(2) }}/5
                    {% else %}
                        <em style="color: #999;">-</em>
                    {% endif %}
                </td>
                <td style="border: 1px solid #ddd; padding: 10px;">
                    {% if all_completed and student_results.final_mark %}
                        {{ student_results.final_mark }}/100
                    {% else %}
                        <em style="color: #999;">-</em>
                    {% endif %}
                </td>
                <td style="border: 1px solid #ddd; padding: 10px; text-align: left;">
                    {% if current_user.role == "lecturer" %}
                        {% for comment in student_results.comments %}
                            <div style="margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-left: 3px solid #007bff;">
                                <strong>{{ comment.reviewer }}:</strong> "{{ comment.comment }}"
                            </div>
                        {% endfor %}
                        {% if not student_results.comments %}
                            <em style="color: #999;">No comments</em>
                        {% endif %}
                    {% else %}
                        {% set my_comments = student_results.comments | selectattr("reviewer_id", "equalto", current_user.id) | list %}
                        {% for comment in my_comments %}
                            <div style="margin-bottom: 8px; padding: 6px; background: #f8f9fa; border-left: 3px solid #007bff;">
                                <strong>You:</strong> "{{ comment.comment }}"
                            </div>
                        {% endfor %}
                        {% if not my_comments %}
                            <em style="color: #999;">You didn’t review this student.</em>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Anonymous Reviews -->
    <div style="margin-bottom: 20px;">
        <h3>Anonymous Reviews</h3>
        {% if current_user.role == "lecturer" %}
            {% for anon_review in anonymous_reviews %}
                <div style="padding: 10px; background: #f8f9fa; border-left: 1px solid #28a745; margin-bottom: 8px;">
                    <strong>Anonymous:</strong> "{{ anon_review.comment }}"
                </div>
            {% endfor %}
            {% if not anonymous_reviews %}
                <em style="color: #999;">No anonymous reviews submitted.</em>
            {% endif %}
        {% else %}
            <em style="color: #999;">Anonymous reviews are visible only to lecturers.</em>
        {% endif %}
    </div>

<!-- Self Assessments — styled, lecturer sees student names; owner sees "You:" -->
<div>
    <h3>Self Assessments</h3>

    {% if not self_assessments %}
        <em style="color: #999;">No self-assessments submitted.</em>
    {% endif %}

    {% for assessment_data in self_assessments %}
        {% set assessment = assessment_data.assessment %}
        {% set student_name = assessment_data.student_name %}
        {% set student_id = assessment_data.student_id if assessment_data.student_id is defined else None %}

        {# Show to lecturer or owner student #}
        {% if current_user.role == "lecturer" or (student_id and current_user.id == student_id) %}

            {# determine label shown before the answer: full name for lecturers, "You" for owner student #}
            {% if current_user.role == "lecturer" %}
                {% set label_name = student_name %}
            {% elif student_id and current_user.id == student_id %}
                {% set label_name = "You" %}
            {% else %}
                {% set label_name = student_name %}
            {% endif %}

            <div style="padding: 14px; background: #f8f9fa; border-left: 4px solid #ffc107; margin-bottom: 14px; border-radius: 8px;">

                <!-- Q1 -->
                <div style="margin-bottom:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">1. Brief summary of your contribution</div>
                    <div style="background:#fff; border:1px solid #e6e9ee; padding:10px; border-radius:6px; white-space:pre-wrap;">
                        <div><strong>{{ label_name }}:</strong></div>
                        <div>
                            {% if assessment.summary %}
                                {{ assessment.summary }}
                            {% else %}
                                <em style="color:#999;"> No answer</em>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Q2 -->
                <div style="margin-bottom:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">2. What challenges did you face & what did you learn?</div>
                    <div style="background:#fff; border:1px solid #e6e9ee; padding:10px; border-radius:6px; white-space:pre-wrap;">
                        <div><strong>{{ label_name }}:</strong></div>
                        <div>
                            {% if assessment.challenges %}
                                {{ assessment.challenges }}
                            {% else %}
                                <em style="color:#999;"> No answer</em>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Q3 -->
                <div style="margin-bottom:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">3. What would you do differently?</div>
                    <div style="background:#fff; border:1px solid #e6e9ee; padding:10px; border-radius:6px; white-space:pre-wrap;">
                        <div><strong>{{ label_name }}:</strong></div>
                        <div>
                            {% if assessment.different %}
                                {{ assessment.different }}
                            {% else %}
                                <em style="color:#999;"> No answer</em>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Q4 -->
                <div style="margin-bottom:10px;">
                    <div style="font-weight:700; margin-bottom:6px;">4. Describe your role and how it helped the team</div>
                    <div style="background:#fff; border:1px solid #e6e9ee; padding:10px; border-radius:6px; white-space:pre-wrap;">
                        <div><strong>{{ label_name }}:</strong></div>
                        <div>
                            {% if assessment.role %}
                                {{ assessment.role }}
                            {% else %}
                                <em style="color:#999;"> No answer</em>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Q5 -->
                <div>
                    <div style="font-weight:700; margin-bottom:6px;">5. Additional feedback (optional)</div>
                    <div style="background:#fff; border:1px solid #e6e9ee; padding:10px; border-radius:6px; white-space:pre-wrap;">
                        <div><strong>{{ label_name }}:</strong></div>
                        <div>
                            {% if assessment.feedback %}
                                {{ assessment.feedback }}
                            {% else %}
                                <em style="color:#999;"> No answer</em>
                            {% endif %}
                        </div>
                    </div>
                </div>

            </div>
        {% endif %}
    {% endfor %}
</div>

</div>
{% endblock %}
