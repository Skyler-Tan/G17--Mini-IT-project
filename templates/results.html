{% extends "base.html" %}

{% block title %}Dashboard - Peer Review App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h2 style="text-align: center;">Peer Review Results</h2>
    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 10px; margin: 10px 0; text-align: center;">
        <strong>Subject:</strong> {{ subject.name }} | <strong>Group:</strong> {{ group.name }}
    </div>
    <br>
    
    <!-- Group Summary -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h4 style="margin: 0 0 10px 0; color: #333;">Group Summary</h4>
        <p style="margin: 5px 0;"><strong>Total Students:</strong> {{ group_students|length }} | 
           <strong>Reviews Completed:</strong> {{ completed_count }}/{{ group_students|length }} | 
           <strong>Status:</strong> 
           {% if all_completed %}
               <span style="color: #28a745;">Complete ✓</span>
           {% else %}
               <span style="color: #dc3545;">In Progress ⏳</span>
           {% endif %}
        </p>
    </div>
    
    <!-- TABLE 1: MAIN RESULTS TABLE -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px;">
        <table class="results-table" style="width: 100%; border-collapse: collapse; text-align: center;">
            <caption style="caption-side: top; text-align: left; padding: 8px 0; color: #6c757d;">
                Peer Review Results for {{ group.name }}
            </caption>
            <thead style="background-color: #f8f9fa;">
                <tr>
                    <th scope="col" style="padding: 10px; border: 1px solid #ddd;">Student</th>
                    {% if all_completed %}
                        <th scope="col" style="padding: 10px; border: 1px solid #ddd;">Avg Peer Score</th>
                        <th scope="col" style="padding: 10px; border: 1px solid #ddd;">Final Mark</th>
                    {% endif %}
                    <th scope="col" style="padding: 10px; border: 1px solid #ddd;">Peer Comments</th>
                </tr>
            </thead>
            <tbody>
                {% for student in group_students %}
                {% set student_results = results[student.id] if results else {} %}
                <tr>
                    <td style="padding: 10px; border: 1px solid #ddd;"><strong>{{ student.full_name }}</strong></td>
                    {% if all_completed %}
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            {% if student_results.avg_score is not none %}
                                <span style="color: #28a745; font-weight: bold;">{{ student_results.avg_score|round(2) }}/5</span>
                            {% else %}
                                <em style="color: #999;">N/A</em>
                            {% endif %}
                        </td>
                        <td style="padding: 10px; border: 1px solid #ddd;">
                            {% if student_results.final_mark is not none %}
                                <span style="color: #007bff; font-weight: bold;">{{ student_results.final_mark }}/100</span>
                            {% else %}
                                <em style="color: #999;">N/A</em>
                            {% endif %}
                        </td>
                    {% endif %}
                    <td style="padding: 10px; border: 1px solid #ddd; text-align: left; max-width: 400px;">
                        {% if current_user.full_name == student.full_name or current_user.role == "lecturer" %}
                            {% if all_completed %}
                                {% if student_results.comments %}
                                    {% for comment in student_results.comments %}
                                        <div style="margin-bottom: 10px; padding: 8px; background: #f8f9fa; border-left: 3px solid #007bff; border-radius: 4px;">
                                            <strong>{{ comment.reviewer }}:</strong> 
                                            <span style="white-space: pre-wrap; overflow-wrap: anywhere;">{{ comment.comment|replace('\n','<br>')|safe }}</span>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <em style="color: #999;">No comments received from peers.</em>
                                {% endif %}
                            {% else %}
                                <em style="color: #999;">Comments will appear once all reviews are completed.</em>
                            {% endif %}
                        {% else %}
                            <em style="color: #999;">Comments are private to each student.</em>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if group_students|length == 0 %}
                <tr><td colspan="{{ 3 if not all_completed else 4 }}" style="padding: 10px; border: 1px solid #ddd; text-align: center; color: #999; font-style: italic;">No students in this group</td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- TABLE 2: WAITING FOR SUBMISSION -->
    {% if not all_completed %}
    <div style="background: #fff3cd; border: 1px solid #ffeeba; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
        <span style="color: #856404; font-weight: bold;">Waiting for all students in {{ group.name }} to complete their reviews and self-assessments</span>
        <br>
        <small style="color: #856404;">Completed: {{ completed_count }}/{{ group_students|length }} students</small>
    </div>
    {% endif %}

    <!-- TABLE 3: ANONYMOUS REVIEW -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 15px 0; text-align: center; font-weight: bold; color: #333;">Anonymous Review for {{ group.name }}</h3>
        {% if current_user.role == "lecturer" %}
            {% if all_completed %}
                {% if anonymous_reviews %}
                    {% for anon_review in anonymous_reviews %}
                    <div style="padding: 15px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 10px;">
                        <strong style="color: #6c757d;">Anonymous Feedback:</strong> 
                        <span style="color: #495057; white-space: pre-wrap; overflow-wrap: anywhere;">{{ anon_review.content|replace('\n','<br>')|safe }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="padding: 15px; text-align: center; color: #999; font-style: italic;">
                        No anonymous reviews submitted for {{ group.name }}
                    </div>
                {% endif %}
            {% else %}
                <div style="padding: 15px; text-align: center; color: #999; font-style: italic;">
                    Anonymous reviews will appear once all reviews are completed for {{ group.name }}
                </div>
            {% endif %}
        {% else %}
            <div style="padding: 15px; text-align: center; color: #999; font-style: italic;">
                Anonymous reviews are visible to the lecturer only.
            </div>
        {% endif %}
    </div>

    <!-- TABLE 4: SELF ASSESSMENT -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h3 style="margin: 0 0 20px 0; text-align: center; font-weight: bold; color: #333;">SELF ASSESSMENT - {{ group.name }}</h3>
        
        {% if all_completed %}
            {% if self_assessments %}
                {% for assessment_data in self_assessments %}
                    {% set assessment = assessment_data.assessment %}
                    {% set student_name = assessment_data.student_name %}
                    
                    <!-- Show assessment if user is the student themselves or lecturer -->
                    {% if current_user.full_name == student_name or current_user.role == "lecturer" %}
                    <div style="margin-bottom: 25px; border: 1px solid #ddd; border-radius: 8px; overflow: hidden;">
                        <div style="background: #e9ecef; padding: 10px 15px; border-bottom: 1px solid #ddd;">
                            <strong style="color: #495057;">{{ student_name }} - {{ group.name }}</strong>
                        </div>
                        <div style="padding: 15px;">
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                                <strong>1. Summary of contribution to {{ group.name }}:</strong>
                                <p style="margin: 5px 0 0 0; color: #495057; white-space: pre-wrap; overflow-wrap: anywhere;">{{ assessment.summary|replace('\n','<br>')|safe }}</p>
                            </div>
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                                <strong>2. Challenges and learning in {{ group.name }}:</strong>
                                <p style="margin: 5px 0 0 0; color: #495057; white-space: pre-wrap; overflow-wrap: anywhere;">{{ assessment.challenges|replace('\n','<br>')|safe }}</p>
                            </div>
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                                <strong>3. What would you do differently in {{ group.name }}:</strong>
                                <p style="margin: 5px 0 0 0; color: #495057; white-space: pre-wrap; overflow-wrap: anywhere;">{{ assessment.different|replace('\n','<br>')|safe }}</p>
                            </div>
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                                <strong>4. Your role in {{ group.name }}:</strong>
                                <p style="margin: 5px 0 0 0; color: #495057; white-space: pre-wrap; overflow-wrap: anywhere;">{{ assessment.role|replace('\n','<br>')|safe }}</p>
                            </div>
                            {% if assessment.feedback %}
                            <div style="margin-bottom: 12px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                                <strong>5. Additional feedback about {{ group.name }}:</strong>
                                <p style="margin: 5px 0 0 0; color: #495057; white-space: pre-wrap; overflow-wrap: anywhere;">{{ assessment.feedback|replace('\n','<br>')|safe }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                {% endfor %}
            {% else %}
                <div style="padding: 15px; text-align: center; color: #999; font-style: italic;">
                    No self assessments submitted for {{ group.name }}
                </div>
            {% endif %}
        {% else %}
            <div style="padding: 15px; text-align: center; color: #999; font-style: italic;">
                Self assessments will appear once all reviews are completed for {{ group.name }}
            </div>
        {% endif %}
    </div>

    <!-- Navigation Buttons -->
    <div style="text-align: center; margin-top: 30px;">
        <a href="{{ url_for('form', group_id=group.id, subject_id=subject.id) }}" class="btn btn-secondary" 
           style="background: #6c757d; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; display: inline-block; text-decoration: none;">
            Edit Reviews
        </a>
        
        <a href="{{ url_for('peer_review', group_id=group.id, subject_id=subject.id) }}" class="btn btn-primary"
           style="background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; display: inline-block; text-decoration: none;">
            Back to Peer Review
        </a>

        <a href="{{ url_for('dashboard') }}" class="btn btn-success"
           style="background: #28a745; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; display: inline-block; text-decoration: none;">
            Back to Dashboard
        </a>
    </div>
</div>
{% endblock %}