{% extends "base.html" %}
{% block content %}
<div class="container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <center>
        <h2>Peer Review - {{ subject_name }}</h2>
        <p style="color: #666; margin-bottom: 30px;">Review your group members for {{ subject_name }} - {{ group_name }}</p>
    </center>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=True) %}
        {% if messages %}
            {% for category, message in messages %}
                <div style="padding: 12px; margin: 15px 0; border-radius: 6px; border-left: 4px solid;
                            {% if category == 'error' %}
                                background: #f8d7da; color: #721c24; border-left-color: #dc3545;
                            {% elif category == 'success' %}
                                background: #d4edda; color: #155724; border-left-color: #28a745;
                            {% else %}
                                background: #d1ecf1; color: #0c5460; border-left-color: #17a2b8;
                            {% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Subject and Group Information -->
    <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 15px; margin-bottom: 25px;">
        <h4 style="margin-top: 0; color: #0066cc;">üìã Review Information</h4>
        <p style="color: #004085; margin-bottom: 5px;"><strong>Subject:</strong> {{ subject_name }}</p>
        <p style="color: #004085; margin-bottom: 5px;"><strong>Group:</strong> {{ group_name }}</p>
        <p style="color: #004085; margin-bottom: 0;"><strong>You are reviewing as:</strong> {{ current_user }}</p>
    </div>

    <form method="POST">
        <input type="hidden" name="subject_id" value="{{ subject_id }}">
        <input type="hidden" name="group_id" value="{{ group_id }}">
        
        {% for student in students %}
            {% if student != current_user %}
            <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #f9f9f9;">
                <h4 style="margin-top: 0; color: #333;">Review for: {{ student }}</h4>
                
                <input type="hidden" name="reviewee[]" value="{{ student }}">
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Score (1-5):</label>
                    <select name="score[]" required style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px;">
                        <option value="">Select a score</option>
                        <option value="1" {% if prior_reviews.get(student, {}).get('score') == 1 %}selected{% endif %}>1 - Needs Improvement</option>
                        <option value="2" {% if prior_reviews.get(student, {}).get('score') == 2 %}selected{% endif %}>2 - Below Average</option>
                        <option value="3" {% if prior_reviews.get(student, {}).get('score') == 3 %}selected{% endif %}>3 - Average</option>
                        <option value="4" {% if prior_reviews.get(student, {}).get('score') == 4 %}selected{% endif %}>4 - Good</option>
                        <option value="5" {% if prior_reviews.get(student, {}).get('score') == 5 %}selected{% endif %}>5 - Excellent</option>
                    </select>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Comments:</label>
                    <textarea name="comment[]" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; resize: vertical;" 
                              placeholder="Provide constructive feedback for {{ student }}...">{% if prior_reviews.get(student, {}).get('comment') %}{{ prior_reviews[student]['comment'] }}{% endif %}</textarea>
                </div>
            </div>
            {% endif %}
        {% endfor %}

        <!-- Anonymous Review Section -->
        <div style="border: 1px solid #ddd; border-radius: 8px; padding: 20px; margin-bottom: 20px; background: #fff3cd;">
            <h4 style="margin-top: 0; color: #856404;">üìù Anonymous Feedback (Optional)</h4>
            <p style="color: #856404; font-size: 14px; margin-bottom: 15px;">
                This feedback will be anonymous and visible only to the lecturer. You can share general thoughts about the group dynamics or {{ subject_name }}.
            </p>
            <textarea name="anonymous_review" rows="4" style="width: 100%; padding: 8px; border: 1px solid #ffc107; border-radius: 4px; resize: vertical;" 
                      placeholder="Enter your anonymous feedback here...">{{ prior_anon_review }}</textarea>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button type="submit" style="background: #007bff; color: white; padding: 12px 30px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px;">
                Submit Reviews
            </button>
        </div>
    </form>
</div>
{% endblock %}