{% extends "base.html" %}

{% block title %}Dashboard - Peer Review App{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 0 auto; padding: 20px;">
    <center>
        <h2>Peer Review Dashboard</h2>
        <div style="background: #e8f4fd; border: 1px solid #b3d9ff; border-radius: 8px; padding: 10px; margin: 10px 0;">
            <strong>Subject:</strong> {{ subject.name }} | <strong>Group:</strong> {{ group.name }}
        </div>
    </center>
    <br>

    <!-- Students Section -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 20px; color: #333;">Students in Your Group ({{ group.name }})</h3>
        
        {% for student in group_students %}
        <div style="display: flex; align-items: center; margin-bottom: 15px;">
            {% set current_user_fullname = current_user.first_name + ' ' + current_user.last_name %}
            
            {% if student.full_name == current_user_fullname %}
                <!-- Current user - clickable -->
                <a href="{{ url_for('switch_user_and_form', username=student.full_name.replace(' ', '_'), group_id=group.id, subject_id=subject.id) }}" 
                   style="text-decoration: none;">
                    <div style="background: #007bff; border: 2px solid #0056b3; border-radius: 15px; padding: 15px 20px; width: 200px; text-align: center; cursor: pointer; transition: all 0.3s;">
                        <strong style="color: white;">{{ student.full_name }} (Click to Review)</strong>
                    </div>
                </a>
                
                <!-- Completion Checkmark -->
                <div style="margin-left: 20px;">
                    {% if completion_status[student.id] and completion_status[student.id].reviews_count > 0 %}
                        <svg width="30" height="30" style="color: #28a745;">
                            <path d="M5 15 L12 22 L25 8" stroke="#28a745" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span style="color: #28a745; font-size: 12px; margin-left: 5px;">Completed</span>
                    {% else %}
                        <div style="width: 30px; height: 30px; border: 2px solid #ffc107; border-radius: 50%; background: #fff3cd;"></div>
                        <span style="color: #856404; font-size: 12px; margin-left: 5px;">Pending</span>
                    {% endif %}
                </div>
            {% else %}
                <!-- Other students - non-clickable, locked -->
                <div style="background: #f8f9fa; border: 2px solid #6c757d; border-radius: 15px; padding: 15px 20px; width: 200px; text-align: center; opacity: 0.6;">
                    <strong style="color: #6c757d;">{{ student.full_name }} (Locked)</strong>
                </div>
                <div style="margin-left: 20px;">
                    <span style="color: #6c757d; font-size: 20px;">üîí</span>
                </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>

    <!-- Group Information -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px;">Group Information</h3>
        <p><strong>Group Name:</strong> {{ group.name }}</p>
        <p><strong>Subject:</strong> {{ subject.name }}</p>
        <p><strong>Total Students in Group:</strong> {{ group_students|length }}</p>
        <p><strong>Reviews Completed:</strong> {{ completed_count }}/{{ group_students|length }}</p>
    </div>

    <!-- Results Preview -->
    <div style="background: #fff; border: 1px solid #ddd; border-radius: 10px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
        <h3 style="margin-bottom: 15px;">Results Preview</h3>
        
        {% if all_completed %}
            <!-- Show peer averages only -->
            <div style="color: #28a745; margin-bottom: 15px;">
                <strong>‚úì All students in your group completed reviews</strong>
            </div>
            
            <table style="width: 100%; border-collapse: collapse;">
                <thead style="background: #f8f9fa;">
                    <tr>
                        <th style="padding: 10px; border: 1px solid #ddd;">Student</th>
                        <th style="padding: 10px; border: 1px solid #ddd;">Avg Peer Score</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in results %}
                    <tr>
                        <td style="padding: 10px; border: 1px solid #ddd;"><strong>{{ result.student_name }}</strong></td>
                        <td style="padding: 10px; border: 1px solid #ddd; color: #28a745;">{{ result.avg_score }}/5</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div style="color: #dc3545; text-align: center; padding: 20px;">
                <strong>‚è≥ Waiting for all students in your group to complete their reviews</strong>
                <br>
                <small style="color: #666;">
                    Completed: {{ completed_count }}/{{ group_students|length }} students
                </small>
            </div>
        {% endif %}
    </div>

    <!-- Navigation -->
    <div style="text-align: center; margin-top: 20px;">
        <a href="{{ url_for('results', group_id=group.id, subject_id=subject.id) }}" 
           style="background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 5px;">
            Results 
        </a>
        <a href="{{ url_for('self_assessment', group_id=group.id, subject_id=subject.id) }}" 
           style="background: #17a2b8; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 5px;">
            Self Assessment
        </a>
        <a href="{{ url_for('dashboard') }}" 
           style="background: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; margin: 5px;">
            Back to Dashboard
        </a>
    </div>
</div>

<style>
/* Hover effects for student buttons */
a div:hover {
    background: #0056b3 !important;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
}
</style>
{% endblock %}